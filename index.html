<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cahier Journal - Planificateur CE2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --secondary: #f472b6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient-start: #faf5ff;
      --bg-gradient-end: #eff6ff;
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 24px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: var(--shadow-lg);
    }

    .logo-text {
      font-family: 'Nunito', sans-serif;
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .week-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      background: white;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      box-shadow: var(--shadow);
      margin: 0 auto;
      width: fit-content;
    }

    .week-nav {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .week-nav:hover {
      background: var(--primary);
      color: white;
    }

    /* Day Navigation */
    .day-nav {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .day-tab {
      padding: 10px 18px;
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      color: var(--text-secondary);
      box-shadow: var(--shadow);
    }

    .day-tab:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .day-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .day-tab.completed {
      background: var(--success);
      color: white;
    }

    .day-tab.recap {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
    }

    /* Main Card */
    .main-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 20px 24px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .card-header.mercredi {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
    }

    .card-header.recap {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    }

    .card-header h2 {
      font-family: 'Nunito', sans-serif;
      font-size: 22px;
      font-weight: 700;
    }

    .card-header-date {
      font-size: 14px;
      opacity: 0.9;
    }

    .card-body {
      padding: 24px;
    }

    /* Slot Card */
    .slot-card {
      background: #f8fafc;
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .slot-card:hover {
      border-color: var(--primary-light);
    }

    .slot-card.break {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      text-align: center;
      padding: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .slot-card.ritual {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #93c5fd;
    }

    .slot-header {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .slot-time {
      font-weight: 700;
      color: var(--primary);
      font-size: 13px;
      min-width: 90px;
    }

    .slot-title-select {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .slot-title-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .slot-body {
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .slot-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .slot-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .slot-field textarea,
    .slot-field input {
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      transition: all 0.2s;
    }

    .slot-field textarea:focus,
    .slot-field input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .slot-field textarea {
      min-height: 60px;
    }

    /* Tools Tags */
    .tools-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tool-tag {
      padding: 6px 12px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tool-tag:hover {
      border-color: var(--primary-light);
    }

    .tool-tag.selected {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .tool-tag.custom {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-color: #f59e0b;
    }

    .tool-tag.custom.selected {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border-color: #d97706;
    }

    .add-tool-btn {
      padding: 6px 10px;
      background: white;
      border: 2px dashed var(--border);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .add-tool-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .add-tool-input {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .add-tool-input input {
      padding: 4px 8px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 12px;
      width: 120px;
    }

    .add-tool-input input:focus {
      outline: none;
    }

    .add-tool-input button {
      padding: 4px 8px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-tool-input .add-confirm {
      background: var(--success);
      color: white;
    }

    .add-tool-input .add-cancel {
      background: var(--border);
      color: var(--text-secondary);
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Recap Styles */
    .recap-day {
      margin-bottom: 24px;
    }

    .recap-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      font-weight: 700;
    }

    .recap-day-header.mercredi {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
    }

    .recap-day-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .recap-day-header button:hover {
      background: rgba(255,255,255,0.3);
    }

    .recap-slots {
      background: white;
      border: 2px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }

    .recap-slot {
      display: grid;
      grid-template-columns: 100px 1fr auto;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      align-items: start;
    }

    .recap-slot:last-child {
      border-bottom: none;
    }

    .recap-slot.break {
      background: #f1f5f9;
      grid-template-columns: 1fr;
      text-align: center;
      color: var(--text-muted);
      font-weight: 500;
      padding: 8px;
    }

    .recap-slot-time {
      font-weight: 600;
      color: var(--primary);
      font-size: 12px;
    }

    .recap-slot-content {
      font-size: 13px;
    }

    .recap-slot-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .recap-slot-detail {
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .recap-slot-tools {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .recap-tool {
      font-size: 10px;
      padding: 2px 8px;
      background: var(--primary);
      color: white;
      border-radius: 10px;
      font-weight: 500;
    }

    .recap-slot-edit {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .recap-slot-edit:hover {
      background: #e2e8f0;
    }

    /* Edit Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Export Panel */
    .export-panel {
      background: #f8fafc;
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 24px;
    }

    .export-panel h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .export-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: white;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .export-option:hover {
      border-color: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .export-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .export-icon.sheets { background: linear-gradient(135deg, #34a853, #0f9d58); }
    .export-icon.pdf { background: linear-gradient(135deg, #ea4335, #c5221f); }
    .export-icon.print { background: linear-gradient(135deg, #6b7280, #4b5563); }

    .export-text h4 { font-size: 14px; font-weight: 600; }
    .export-text p { font-size: 12px; color: var(--text-secondary); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--success);
      color: white;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-xl);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }

    /* Print */
    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .main-card { box-shadow: none; }
    }

    /* Responsive */
    @media (max-width: 640px) {
      .app-container { padding: 12px; }
      .card-body { padding: 16px; }
      .day-tab { padding: 8px 12px; font-size: 12px; }
      .slot-header { flex-direction: column; align-items: stretch; }
      .slot-time { min-width: auto; }
      .nav-buttons { flex-direction: column; gap: 12px; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ==================== DATA ====================
    const DAYS_CONFIG = [
      { id: 'lundi', name: 'Lundi', hasRituals: true, isMorningOnly: false },
      { id: 'mardi', name: 'Mardi', hasRituals: true, isMorningOnly: false },
      { id: 'mercredi', name: 'Mercredi', hasRituals: false, isMorningOnly: true },
      { id: 'jeudi', name: 'Jeudi', hasRituals: true, isMorningOnly: false },
      { id: 'vendredi', name: 'Vendredi', hasRituals: true, isMorningOnly: false },
    ];

    // Cr√©neaux par jour bas√©s sur le document
    const SLOTS_BY_DAY = {
      lundi: [
        { id: 'l1', time: '8h30 - 9h', type: 'ritual', defaultTitle: 'Rituels', defaultContent: 'Programme du jour, Calendrier, Mot du jour (15 min), Top chrono (5 min)', defaultTools: ['Calendrier', 'Cahier du jour'] },
        { id: 'l2', time: '9h - 9h45', type: 'normal', defaultTitle: 'Orthographe' },
        { id: 'l3', time: '9h45 - 10h10', type: 'normal', defaultTitle: 'Grammaire' },
        { id: 'l4', time: '10h10 - 10h30', type: 'break', label: 'R√©cr√©ation' },
        { id: 'l5', time: '10h30 - 11h30', type: 'normal', defaultTitle: 'Math√©matiques' },
        { id: 'l6', time: '11h30 - 13h30', type: 'break', label: 'Cantine' },
        { id: 'l7', time: '13h30 - 13h50', type: 'fixed', defaultTitle: 'Silence on lit' },
        { id: 'l8', time: '13h50 - 14h', type: 'fixed', defaultTitle: 'Devoirs' },
        { id: 'l9', time: '14h - 14h55', type: 'normal', defaultTitle: 'Questionner le monde' },
        { id: 'l10', time: '14h55 - 15h10', type: 'break', label: 'R√©cr√©ation' },
        { id: 'l11', time: '15h15 - 15h25', type: 'normal', defaultTitle: 'Lecture fluence' },
        { id: 'l12', time: '15h30 - 16h30', type: 'normal', defaultTitle: 'Arts plastiques' },
      ],
      mardi: [
        { id: 'm1', time: '8h30 - 9h', type: 'ritual', defaultTitle: 'Rituels', defaultContent: 'Programme du jour, Calendrier, Mot du jour (15 min), Nombre du jour (5 min)', defaultTools: ['Calendrier', 'Cahier du jour'] },
        { id: 'm2', time: '9h - 9h30', type: 'normal', defaultTitle: 'Orthographe' },
        { id: 'm3', time: '9h30 - 10h10', type: 'normal', defaultTitle: 'Math√©matiques' },
        { id: 'm4', time: '10h10 - 10h30', type: 'break', label: 'R√©cr√©ation' },
        { id: 'm5', time: '10h30 - 11h30', type: 'normal', defaultTitle: 'Musique' },
        { id: 'm6', time: '11h30 - 13h30', type: 'break', label: 'Cantine' },
        { id: 'm7', time: '13h30 - 13h50', type: 'fixed', defaultTitle: 'Silence on lit' },
        { id: 'm8', time: '13h50 - 14h', type: 'fixed', defaultTitle: 'Devoirs' },
        { id: 'm9', time: '14h - 14h15', type: 'normal', defaultTitle: 'Copie' },
        { id: 'm10', time: '14h15 - 14h55', type: 'normal', defaultTitle: 'Vocabulaire' },
      ],
      mercredi: [
        { id: 'me1', time: '8h30 - 10h10', type: 'normal', defaultTitle: 'EPS' },
        { id: 'me2', time: '10h10 - 10h30', type: 'break', label: 'R√©cr√©ation' },
        { id: 'me3', time: '10h30 - 10h50', type: 'normal', defaultTitle: 'Orthographe' },
        { id: 'me4', time: '10h50 - 11h30', type: 'normal', defaultTitle: 'Math√©matiques' },
      ],
      jeudi: [
        { id: 'j1', time: '8h30 - 9h', type: 'ritual', defaultTitle: 'Rituels', defaultContent: 'Programme du jour, Calendrier, Mot du jour (15 min), Top chrono (5 min)', defaultTools: ['Cahier du jour'] },
        { id: 'j2', time: '9h - 10h', type: 'normal', defaultTitle: 'Conjugaison' },
        { id: 'j3', time: '10h - 10h10', type: 'normal', defaultTitle: 'Calcul mental' },
        { id: 'j4', time: '10h10 - 10h30', type: 'break', label: 'R√©cr√©ation' },
        { id: 'j5', time: '10h30 - 11h30', type: 'normal', defaultTitle: 'Math√©matiques' },
        { id: 'j6', time: '11h30 - 13h30', type: 'break', label: 'Cantine' },
        { id: 'j7', time: '13h30 - 13h45', type: 'fixed', defaultTitle: 'Silence on lit' },
        { id: 'j8', time: '13h45 - 13h50', type: 'fixed', defaultTitle: 'Devoirs' },
        { id: 'j9', time: '13h50 - 14h25', type: 'normal', defaultTitle: "Production d'√©crits" },
        { id: 'j10', time: '14h25 - 14h55', type: 'normal', defaultTitle: 'Anglais' },
        { id: 'j11', time: '14h55 - 15h10', type: 'break', label: 'R√©cr√©ation' },
        { id: 'j12', time: '15h15 - 15h45', type: 'normal', defaultTitle: 'Orthographe' },
        { id: 'j13', time: '15h45 - 16h30', type: 'normal', defaultTitle: 'Questionner le monde' },
      ],
      vendredi: [
        { id: 'v1', time: '8h30 - 9h', type: 'ritual', defaultTitle: 'Rituels', defaultContent: 'Programme de la journ√©e, Calendrier, Mot du jour (15 min), Top chrono (5 min)', defaultTools: ['Calendrier', 'Cahier du jour'] },
        { id: 'v2', time: '9h - 9h30', type: 'normal', defaultTitle: 'Orthographe' },
        { id: 'v3', time: '9h30 - 10h10', type: 'normal', defaultTitle: 'Lecture compr√©hension' },
        { id: 'v4', time: '10h10 - 10h30', type: 'break', label: 'R√©cr√©ation' },
        { id: 'v5', time: '10h30 - 11h30', type: 'normal', defaultTitle: 'Math√©matiques' },
        { id: 'v6', time: '11h30 - 13h30', type: 'break', label: 'Cantine' },
        { id: 'v7', time: '13h30 - 13h50', type: 'fixed', defaultTitle: 'Silence on lit' },
        { id: 'v8', time: '13h50 - 14h', type: 'fixed', defaultTitle: 'Devoirs' },
        { id: 'v9', time: '14h - 14h55', type: 'normal', defaultTitle: 'EMC' },
      ],
    };

    const SUBJECTS = [
      'Rituels', 'Orthographe', 'Grammaire', 'Conjugaison', 'Vocabulaire',
      'Math√©matiques', 'Calcul mental', 'Lecture fluence', 'Lecture compr√©hension',
      "Production d'√©crits", 'Copie', 'Questionner le monde', 'EMC', 'Anglais',
      'Arts plastiques', 'Musique', 'EPS', 'Devoirs', 'Silence on lit'
    ];

    const DEFAULT_TOOLS = [
      'Cahier du jour', "Cahier d'√©crivain", 'Ardoise', 'Calendrier',
      'Manuel', 'Fichier', 'Tableau', 'Vid√©oprojecteur'
    ];

    // ==================== UTILITY FUNCTIONS ====================
    const getWeekNumber = (date) => {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
      const week1 = new Date(d.getFullYear(), 0, 4);
      return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    };

    const getWeekDates = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));

      return DAYS_CONFIG.map((_, index) => {
        const dayDate = new Date(monday);
        dayDate.setDate(monday.getDate() + index);
        return dayDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
      });
    };

    // ==================== COMPONENTS ====================

    // Slot Card Component
    const SlotCard = ({ slot, data, onChange, customTools, onAddCustomTool }) => {
      const [showAddTool, setShowAddTool] = useState(false);
      const [newToolName, setNewToolName] = useState('');

      if (slot.type === 'break') {
        return <div className="slot-card break">‚òï {slot.label}</div>;
      }

      const isRitual = slot.type === 'ritual';
      const isFixed = slot.type === 'fixed';
      const allTools = [...DEFAULT_TOOLS, ...customTools];

      const handleChange = (field, value) => {
        onChange({ ...data, [field]: value });
      };

      const toggleTool = (tool) => {
        const currentTools = data.tools || [];
        const newTools = currentTools.includes(tool)
          ? currentTools.filter(t => t !== tool)
          : [...currentTools, tool];
        onChange({ ...data, tools: newTools });
      };

      const handleAddTool = () => {
        if (newToolName.trim() && !allTools.includes(newToolName.trim())) {
          onAddCustomTool(newToolName.trim());
          setNewToolName('');
          setShowAddTool(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter') handleAddTool();
        if (e.key === 'Escape') {
          setShowAddTool(false);
          setNewToolName('');
        }
      };

      return (
        <div className={`slot-card ${isRitual ? 'ritual' : ''}`}>
          <div className="slot-header">
            <span className="slot-time">{slot.time}</span>
            {isFixed ? (
              <span style={{ fontWeight: 600, flex: 1 }}>{slot.defaultTitle}</span>
            ) : (
              <select
                className="slot-title-select"
                value={data.title || slot.defaultTitle || ''}
                onChange={(e) => handleChange('title', e.target.value)}
              >
                <option value="">‚Äî Choisir une mati√®re ‚Äî</option>
                {SUBJECTS.map(subj => (
                  <option key={subj} value={subj}>{subj}</option>
                ))}
              </select>
            )}
          </div>

          {!isFixed && (
            <div className="slot-body">
              <div className="slot-field">
                <label>üìù Contenu / Description</label>
                <textarea
                  value={data.content || ''}
                  onChange={(e) => handleChange('content', e.target.value)}
                  placeholder="Dict√©e, exercices, page du manuel..."
                />
              </div>

              <div className="slot-field">
                <label>üéí Outils</label>
                <div className="tools-container">
                  {DEFAULT_TOOLS.map(tool => (
                    <span
                      key={tool}
                      className={`tool-tag ${(data.tools || []).includes(tool) ? 'selected' : ''}`}
                      onClick={() => toggleTool(tool)}
                    >
                      {tool}
                    </span>
                  ))}
                  {customTools.map(tool => (
                    <span
                      key={tool}
                      className={`tool-tag custom ${(data.tools || []).includes(tool) ? 'selected' : ''}`}
                      onClick={() => toggleTool(tool)}
                    >
                      {tool}
                    </span>
                  ))}

                  {showAddTool ? (
                    <div className="add-tool-input">
                      <input
                        type="text"
                        value={newToolName}
                        onChange={(e) => setNewToolName(e.target.value)}
                        onKeyDown={handleKeyPress}
                        placeholder="Nom de l'outil"
                        autoFocus
                      />
                      <button className="add-confirm" onClick={handleAddTool}>‚úì</button>
                      <button className="add-cancel" onClick={() => { setShowAddTool(false); setNewToolName(''); }}>‚úï</button>
                    </div>
                  ) : (
                    <button className="add-tool-btn" onClick={() => setShowAddTool(true)}>
                      + Ajouter
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Day View Component
    const DayView = ({ dayConfig, slots, schedule, setSchedule, customTools, onAddCustomTool }) => {
      const updateSlot = (slotId, data) => {
        setSchedule(prev => ({
          ...prev,
          [slotId]: data
        }));
      };

      return (
        <div className="animate-fadeIn">
          {slots.map(slot => (
            <SlotCard
              key={slot.id}
              slot={slot}
              data={schedule[slot.id] || {
                title: slot.defaultTitle || '',
                content: slot.defaultContent || '',
                tools: slot.defaultTools || []
              }}
              onChange={(data) => updateSlot(slot.id, data)}
              customTools={customTools}
              onAddCustomTool={onAddCustomTool}
            />
          ))}
        </div>
      );
    };

    // Edit Modal Component
    const EditModal = ({ slot, data, onSave, onClose, customTools, onAddCustomTool }) => {
      const [formData, setFormData] = useState(data);
      const [showAddTool, setShowAddTool] = useState(false);
      const [newToolName, setNewToolName] = useState('');
      const allTools = [...DEFAULT_TOOLS, ...customTools];

      const handleChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      const toggleTool = (tool) => {
        const currentTools = formData.tools || [];
        const newTools = currentTools.includes(tool)
          ? currentTools.filter(t => t !== tool)
          : [...currentTools, tool];
        setFormData(prev => ({ ...prev, tools: newTools }));
      };

      const handleAddTool = () => {
        if (newToolName.trim() && !allTools.includes(newToolName.trim())) {
          onAddCustomTool(newToolName.trim());
          setNewToolName('');
          setShowAddTool(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>‚úèÔ∏è Modifier {slot.time}</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body">
              <div className="slot-field" style={{ marginBottom: 16 }}>
                <label>üìö Mati√®re</label>
                <select
                  className="slot-title-select"
                  value={formData.title || ''}
                  onChange={(e) => handleChange('title', e.target.value)}
                  style={{ width: '100%' }}
                >
                  <option value="">‚Äî Choisir ‚Äî</option>
                  {SUBJECTS.map(subj => (
                    <option key={subj} value={subj}>{subj}</option>
                  ))}
                </select>
              </div>

              <div className="slot-field" style={{ marginBottom: 16 }}>
                <label>üìù Contenu</label>
                <textarea
                  value={formData.content || ''}
                  onChange={(e) => handleChange('content', e.target.value)}
                  placeholder="Description de l'activit√©..."
                  style={{ width: '100%', minHeight: 80 }}
                />
              </div>

              <div className="slot-field">
                <label>üéí Outils</label>
                <div className="tools-container">
                  {DEFAULT_TOOLS.map(tool => (
                    <span
                      key={tool}
                      className={`tool-tag ${(formData.tools || []).includes(tool) ? 'selected' : ''}`}
                      onClick={() => toggleTool(tool)}
                    >
                      {tool}
                    </span>
                  ))}
                  {customTools.map(tool => (
                    <span
                      key={tool}
                      className={`tool-tag custom ${(formData.tools || []).includes(tool) ? 'selected' : ''}`}
                      onClick={() => toggleTool(tool)}
                    >
                      {tool}
                    </span>
                  ))}
                  {showAddTool ? (
                    <div className="add-tool-input">
                      <input
                        type="text"
                        value={newToolName}
                        onChange={(e) => setNewToolName(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') handleAddTool();
                          if (e.key === 'Escape') { setShowAddTool(false); setNewToolName(''); }
                        }}
                        placeholder="Nom"
                        autoFocus
                      />
                      <button className="add-confirm" onClick={handleAddTool}>‚úì</button>
                      <button className="add-cancel" onClick={() => { setShowAddTool(false); setNewToolName(''); }}>‚úï</button>
                    </div>
                  ) : (
                    <button className="add-tool-btn" onClick={() => setShowAddTool(true)}>+ Ajouter</button>
                  )}
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={onClose}>Annuler</button>
              <button className="btn btn-primary" onClick={() => onSave(formData)}>Enregistrer</button>
            </div>
          </div>
        </div>
      );
    };

    // Recap View Component
    const RecapView = ({ schedule, setSchedule, weekDates, setCurrentDay, showToast, customTools, onAddCustomTool }) => {
      const [editingSlot, setEditingSlot] = useState(null);

      const handleSaveEdit = (slotId, data) => {
        setSchedule(prev => ({ ...prev, [slotId]: data }));
        setEditingSlot(null);
        showToast('‚úÖ Modification enregistr√©e');
      };

      const exportToGoogleSheets = () => {
        let tsv = '';
        DAYS_CONFIG.forEach((day, dayIndex) => {
          tsv += `\n${day.name.toUpperCase()} - ${weekDates[dayIndex]}\n`;
          tsv += 'Horaire\tMati√®re\tContenu\tOutils\n';

          SLOTS_BY_DAY[day.id].forEach(slot => {
            if (slot.type === 'break') {
              tsv += `${slot.time}\t${slot.label}\t\t\n`;
            } else {
              const data = schedule[slot.id] || {};
              const tools = (data.tools || []).join(', ');
              tsv += `${slot.time}\t${data.title || slot.defaultTitle || ''}\t${data.content || ''}\t${tools}\n`;
            }
          });
        });

        navigator.clipboard.writeText(tsv).then(() => {
          showToast('üìã Copi√© ! Colle dans Google Sheets');
        });
      };

      const exportToPDF = () => {
        const element = document.getElementById('recap-print');
        html2pdf().set({
          margin: 10,
          filename: `cahier-journal-semaine-${getWeekNumber(new Date())}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(element).save();
        showToast('üìÑ PDF g√©n√©r√© !');
      };

      return (
        <div className="animate-fadeIn">
          <div id="recap-print">
            {DAYS_CONFIG.map((day, dayIndex) => (
              <div key={day.id} className="recap-day">
                <div className={`recap-day-header ${day.id === 'mercredi' ? 'mercredi' : ''}`}>
                  <span>{day.name} {weekDates[dayIndex]}</span>
                  <button onClick={() => setCurrentDay(dayIndex)} className="no-print">
                    ‚úèÔ∏è Modifier
                  </button>
                </div>
                <div className="recap-slots">
                  {SLOTS_BY_DAY[day.id].map(slot => {
                    if (slot.type === 'break') {
                      return (
                        <div key={slot.id} className="recap-slot break">
                          ‚òï {slot.label}
                        </div>
                      );
                    }

                    const data = schedule[slot.id] || {
                      title: slot.defaultTitle,
                      content: slot.defaultContent,
                      tools: slot.defaultTools
                    };

                    return (
                      <div key={slot.id} className="recap-slot">
                        <div className="recap-slot-time">{slot.time}</div>
                        <div className="recap-slot-content">
                          <div className="recap-slot-title">{data.title || slot.defaultTitle || '‚Äî'}</div>
                          {data.content && (
                            <div className="recap-slot-detail">{data.content}</div>
                          )}
                          {data.tools && data.tools.length > 0 && (
                            <div className="recap-slot-tools" style={{ marginTop: 4 }}>
                              {data.tools.map(tool => (
                                <span key={tool} className="recap-tool">{tool}</span>
                              ))}
                            </div>
                          )}
                        </div>
                        <button
                          className="recap-slot-edit no-print"
                          onClick={() => setEditingSlot({ slot, data })}
                        >
                          ‚úèÔ∏è
                        </button>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>

          <div className="export-panel no-print">
            <h3>üì§ Exporter le planning</h3>
            <div className="export-options">
              <div className="export-option" onClick={exportToGoogleSheets}>
                <div className="export-icon sheets">üìä</div>
                <div className="export-text">
                  <h4>Google Sheets</h4>
                  <p>Copier pour tableur</p>
                </div>
              </div>
              <div className="export-option" onClick={exportToPDF}>
                <div className="export-icon pdf">üìÑ</div>
                <div className="export-text">
                  <h4>PDF</h4>
                  <p>T√©l√©charger</p>
                </div>
              </div>
              <div className="export-option" onClick={() => window.print()}>
                <div className="export-icon print">üñ®Ô∏è</div>
                <div className="export-text">
                  <h4>Imprimer</h4>
                  <p>Impression directe</p>
                </div>
              </div>
            </div>
          </div>

          {editingSlot && (
            <EditModal
              slot={editingSlot.slot}
              data={editingSlot.data}
              onSave={(data) => handleSaveEdit(editingSlot.slot.id, data)}
              onClose={() => setEditingSlot(null)}
              customTools={customTools}
              onAddCustomTool={onAddCustomTool}
            />
          )}
        </div>
      );
    };

    // Toast Component
    const Toast = ({ message, visible }) => {
      if (!visible) return null;
      return <div className="toast">{message}</div>;
    };

    // ==================== MAIN APP ====================
    const App = () => {
      const [currentDay, setCurrentDay] = useState(0); // 0-4 = jours, 5 = recap
      const [weekDate, setWeekDate] = useState(new Date());
      const [schedule, setSchedule] = useState({});
      const [toast, setToast] = useState({ message: '', visible: false });
      const [customTools, setCustomTools] = useState([]);

      const weekDates = useMemo(() => getWeekDates(weekDate), [weekDate]);
      const isRecap = currentDay === 5;

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('cahierJournal_schedule');
        if (saved) {
          setSchedule(JSON.parse(saved));
        }
        const savedTools = localStorage.getItem('cahierJournal_customTools');
        if (savedTools) {
          setCustomTools(JSON.parse(savedTools));
        }
      }, []);

      // Save to localStorage
      useEffect(() => {
        localStorage.setItem('cahierJournal_schedule', JSON.stringify(schedule));
      }, [schedule]);

      useEffect(() => {
        localStorage.setItem('cahierJournal_customTools', JSON.stringify(customTools));
      }, [customTools]);

      const showToast = (message) => {
        setToast({ message, visible: true });
        setTimeout(() => setToast({ message: '', visible: false }), 3000);
      };

      const navigateWeek = (direction) => {
        const newDate = new Date(weekDate);
        newDate.setDate(newDate.getDate() + (direction * 7));
        setWeekDate(newDate);
      };

      const goToNextStep = () => {
        if (currentDay < 5) setCurrentDay(currentDay + 1);
      };

      const goToPrevStep = () => {
        if (currentDay > 0) setCurrentDay(currentDay - 1);
      };

      const handleAddCustomTool = (toolName) => {
        if (!customTools.includes(toolName)) {
          setCustomTools(prev => [...prev, toolName]);
          showToast(`‚úÖ Outil "${toolName}" ajout√© !`);
        }
      };

      const currentDayConfig = DAYS_CONFIG[currentDay];
      const currentSlots = currentDayConfig ? SLOTS_BY_DAY[currentDayConfig.id] : [];

      return (
        <div className="app-container">
          {/* Header */}
          <header className="header no-print">
            <div className="logo">
              <div className="logo-icon">üìì</div>
              <span className="logo-text">Cahier Journal</span>
            </div>
            <div className="week-badge">
              <button className="week-nav" onClick={() => navigateWeek(-1)}>‚Üê</button>
              <span>Semaine {getWeekNumber(weekDate)}</span>
              <button className="week-nav" onClick={() => navigateWeek(1)}>‚Üí</button>
            </div>
          </header>

          {/* Day Navigation */}
          <nav className="day-nav no-print">
            {DAYS_CONFIG.map((day, index) => (
              <button
                key={day.id}
                className={`day-tab ${currentDay === index ? 'active' : ''}`}
                onClick={() => setCurrentDay(index)}
              >
                {day.name}
              </button>
            ))}
            <button
              className={`day-tab recap ${currentDay === 5 ? 'active' : ''}`}
              onClick={() => setCurrentDay(5)}
            >
              üìã R√©cap
            </button>
          </nav>

          {/* Main Card */}
          <main className="main-card">
            {!isRecap ? (
              <>
                <div className={`card-header ${currentDayConfig?.id === 'mercredi' ? 'mercredi' : ''}`}>
                  <h2>{currentDayConfig?.name}</h2>
                  <span className="card-header-date">{weekDates[currentDay]}</span>
                </div>
                <div className="card-body">
                  <DayView
                    dayConfig={currentDayConfig}
                    slots={currentSlots}
                    schedule={schedule}
                    setSchedule={setSchedule}
                    customTools={customTools}
                    onAddCustomTool={handleAddCustomTool}
                  />
                </div>
              </>
            ) : (
              <>
                <div className="card-header recap">
                  <h2>üìã R√©capitulatif de la semaine</h2>
                  <span className="card-header-date">Semaine {getWeekNumber(weekDate)}</span>
                </div>
                <div className="card-body">
                  <RecapView
                    schedule={schedule}
                    setSchedule={setSchedule}
                    weekDates={weekDates}
                    setCurrentDay={setCurrentDay}
                    showToast={showToast}
                    customTools={customTools}
                    onAddCustomTool={handleAddCustomTool}
                  />
                </div>
              </>
            )}

            {/* Navigation */}
            <div className="nav-buttons no-print">
              <button
                className="btn btn-secondary"
                onClick={goToPrevStep}
                disabled={currentDay === 0}
              >
                ‚Üê Pr√©c√©dent
              </button>

              {currentDay < 5 ? (
                <button className="btn btn-primary" onClick={goToNextStep}>
                  {currentDay === 4 ? 'Voir le r√©cap ‚Üí' : 'Suivant ‚Üí'}
                </button>
              ) : (
                <button className="btn btn-success" onClick={() => window.print()}>
                  üñ®Ô∏è Imprimer
                </button>
              )}
            </div>
          </main>

          <Toast message={toast.message} visible={toast.visible} />

          <footer style={{ textAlign: 'center', marginTop: 24, color: 'var(--text-muted)', fontSize: 13 }} className="no-print">
            üíú Cahier Journal - Planificateur pour enseignants
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
